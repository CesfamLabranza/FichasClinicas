<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Sistema de Fichas y Control</title>

  <!-- Chart.js (Fichas Cl√≠nicas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (Reloj Control) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .tabs { display: flex; background-color: #333; }
    .tab { flex: 1; padding: 15px; color: white; text-align: center; cursor: pointer; background-color: #333; border-bottom: 3px solid transparent; }
    .tab:hover, .tab.active { background-color: #444; border-bottom: 3px solid #4285F4; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }

    /* ===== Estilos FICHAS CL√çNICAS ===== */
    .header-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 15px; }
    .title-search { display: flex; align-items: center; gap: 15px; }
    .title-search input { padding: 8px; width: 300px; font-size: 16px; border: 2px solid #333; }
    .stats-chart { display: grid; grid-template-columns: 55% 45%; gap: 15px; align-items: start; }
    .stats-box { background: #f9f9f9; padding: 12px; border-radius: 8px; border: 2px solid #ccc; }
    .stats-inline { display: flex; gap: 12px; margin-bottom: 10px; }
    .stats-inline span { background: #fff; padding: 6px 10px; border-radius: 5px; border: 1px solid #ddd; font-weight: 500; }
    .chart-box { background: #fff; padding: 8px; }
    .chart-box canvas { width: 100% !important; height: 180px !important; }
    .table-container { height: 300px; overflow: auto; border: 1px solid #ccc; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background-color: #333; color: white; position: sticky; top: 0; }
    .bottom-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 15px; }
    .btn { background: #4285F4; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.3s; }
    .btn:hover { background: #3367d6; transform: scale(1.05); }

    /* Modales */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; text-align: center; width: 350px; }

    .modal input { width: 80%; padding: 8px; margin-top: 10px; border: 1px solid #ccc; }
    .close-btn { margin-top: 15px; background: red; color: white; padding: 8px 15px; border: none; cursor: pointer; }

    /* Lista Archivos */
    #listaArchivos { max-height: 250px; overflow-y: auto; padding: 0; margin: 0; text-align: left; }
    #listaArchivos li { list-style: none; padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; gap: 12px; }
    #listaArchivos li:hover { background-color: #f7f7f7; }
    .file-meta { font-size: 12px; opacity: .7; white-space: nowrap; }

    /* RELOJ CONTROL */
    #logProceso { background:#f7f7f7; padding:10px; border:1px solid #ddd; max-height:260px; overflow:auto; }
  </style>
</head>

<body>
  <!-- ====== Pesta√±as ====== -->
  <div class="tabs">
<div class="tab" onclick="showTab('fichasClinicas')">FICHAS CL√çNICAS</div>
<div class="tab" onclick="showTab('relojControl')">RELOJ CONTROL</div>
<div class="tab" onclick="showTab('confirmacionCitas')">CONFIRMAR CITAS</div>
  </div>

  <!-- ============== FICHAS CL√çNICAS (SIN TOCAR) ============== -->
  <div id="fichasClinicas" class="tab-content active">

    <!-- Encabezado -->
    <div class="header-grid">
      <div class="title-search">
        <h2>Buscar por RUT</h2>
        <input type="text" id="searchInput" placeholder="Ej: 12.345.678-K" oninput="formatRUT(this)">
      </div>

      <!-- Cantidades + Gr√°fico -->
      <div class="stats-chart">
        <div class="stats-box">
          <h3>üìå Cantidades</h3>
          <div class="stats-inline">
            <span>üìä Total: <span id="totalRegistros">0</span></span>
            <span>‚ùå A eliminar: <span id="totalEliminar">0</span></span>
          </div>
          <div>üìÖ A√±os: <span id="conteoPorAno"></span></div>
        </div>
        <div class="chart-box">
          <canvas id="graficoAnios"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla principal -->
    <div class="table-container">
      <table id="dataTable"></table>
    </div>

    <!-- Tabla eliminar -->
    <h3>Registros con m√°s de 15 a√±os sin atenci√≥n:</h3>
    <div class="table-container">
      <table id="eliminarTable"></table>
    </div>

    <!-- Botones -->
    <div class="bottom-buttons">
      <button class="btn" onclick="openModal('apkModal')">‚¨á Descargar APK</button>
      <button class="btn" onclick="openArchivosModal()">üìÅ Archivos</button>
      <button class="btn" onclick="openModal('planillaModal')">‚úè Editar</button>
    </div>

    <!-- Modal Ver Planilla -->
    <div id="planillaModal" class="modal">
      <div class="modal-content">
        <h3>Ingrese clave para acceder</h3>
        <input type="password" id="claveAcceso" placeholder="Clave" />
        <br />
        <button class="btn" onclick="verificarClave()">Acceder</button>
        <button class="close-btn" onclick="closeModal('planillaModal')">Cerrar</button>
      </div>
    </div>

    <!-- Modal Archivos (LISTA DIN√ÅMICA DESDE DRIVE) -->
    <div id="archivosModal" class="modal">
      <div class="modal-content" style="max-width: 560px; text-align:left;">
        <h3 style="text-align:center;">Archivos Disponibles</h3>
        <div id="estadoArchivos" style="font-size:13px; opacity:.8; margin-bottom:8px;"></div>
        <ul id="listaArchivos"></ul>
        <div style="text-align:center; margin-top:12px;">
          <button class="close-btn" onclick="closeModal('archivosModal')">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal APK -->
    <div id="apkModal" class="modal">
      <div class="modal-content" style="width: 400px; text-align: left;">
        <h3 style="text-align: center;">Instrucciones para instalar la APK</h3>
        <div class="instrucciones">
          <p><span class="badge">1Ô∏è‚É£</span> Descarga el archivo APK.</p>
          <p><span class="badge">2Ô∏è‚É£</span> Activa la opci√≥n "Permitir instalar desde or√≠genes desconocidos" en tu dispositivo.</p>
          <p><span class="badge">3Ô∏è‚É£</span> Instala y disfruta la aplicaci√≥n.</p>
        </div>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn" onclick="window.open('https://drive.google.com/uc?export=download&id=1Up8MQiEjR42Xr16vbiGKMvz_ADmItsaj', '_blank')">Descargar APK</button>
          <button class="close-btn" onclick="closeModal('apkModal')">Cerrar</button>
        </div>
      </div>
    </div>

  </div>
  <!-- ===== FIN FICHAS CL√çNICAS ===== -->

  <!-- ===================== RELOJ CONTROL (100% en navegador) ===================== -->
  <div id="relojControl" class="tab-content">
    <h2>RELOJ CONTROL</h2>

    <form id="formRelojControl" style="margin-top: 20px;">
      <label for="archivo">Selecciona un archivo Excel (.xls):</label><br><br>
      <input type="file" name="archivo" id="archivo" accept=".xls" required />
      <br><br>
      <button type="submit" class="btn">Procesar archivo</button>
    </form>

    <p id="estadoProceso" style="margin-top: 10px; font-weight: bold;"></p>
    <pre id="logProceso"></pre>

    <p style="font-size:12px;opacity:.8">
      * Este procesador asume que el .xls del reloj es un HTML con extensi√≥n .xls.
    </p>
  </div>

  <!-- ======= Scripts globales ======= -->
  <script>
    // Tabs
    function showTab(tabId) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // ====== FICHAS CL√çNICAS (SIN TOCAR) ======
    const sheetID = "1r4oZdMkehQZmUX87nK8-bxMwxk-3a70XUfYV-V0QaBM";
    const sheetName = "Hoja 1";
    const query = encodeURIComponent("SELECT A,B,C,D,E,F,G,H");
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

    function formatRUT(input) {
      let value = input.value.replace(/[^0-9kK]/g, '').toUpperCase();
      if (value.length > 1) {
        value = value.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '-' + value.slice(-1);
      }
      input.value = value;
      filtrarTabla(value);
    }
    function openModal(id) { document.getElementById(id).style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function verificarClave() {
      const clave = document.getElementById("claveAcceso").value;
      if (clave === "infolabranza") {
        window.open("https://drive.google.com/drive/folders/1XKg9Odl_A9QtUHOdsKocgR8qHwTgpCVt?usp=sharing", "_blank");
        closeModal('planillaModal');
      } else {
        alert("Clave incorrecta");
      }
    }
    function descargarArchivo(url) { window.open(url, '_blank'); }

    fetch(url)
      .then(res => res.text())
      .then(rep => {
        const data = JSON.parse(rep.substr(47).slice(0, -2));
        const table = document.getElementById("dataTable");
        const eliminarTable = document.getElementById("eliminarTable");
        const tbody = document.createElement("tbody");
        const eliminarBody = document.createElement("tbody");

        const headers = data.table.cols.map(col => `<th>${col.label || ""}</th>`).join('');
        table.innerHTML = `<thead><tr>${headers}</tr></thead>`;
        eliminarTable.innerHTML = `<thead><tr>${headers}</tr></thead>`;

        const hoy = new Date();
        const hace15 = new Date(hoy.getFullYear() - 15, hoy.getMonth(), hoy.getDate());
        let total = 0, totalEliminar = 0;
        const conteoPorAno = {};

        data.table.rows.forEach(row => {
          const cells = row.c.map(cell => `<td>${(cell && (cell.f || cell.v)) || ''}</td>`);
          const tr = document.createElement("tr");
          tr.innerHTML = cells.join('');
          tbody.appendChild(tr);
          total++;

          const fechaUltima = (row.c[3] && (row.c[3].f || row.c[3].v)) || '';
          const fechaParsed = parseFecha(fechaUltima);
          if (fechaParsed) {
            const year = fechaParsed.getFullYear();
            conteoPorAno[year] = (conteoPorAno[year] || 0) + 1;
          }
          if (fechaParsed && fechaParsed <= hace15) {
            const tr2 = document.createElement("tr");
            tr2.innerHTML = cells.join('');
            eliminarBody.appendChild(tr2);
            totalEliminar++;
          }
        });

        table.appendChild(tbody);
        eliminarTable.appendChild(eliminarBody);
        document.getElementById("totalRegistros").textContent = total;
        document.getElementById("totalEliminar").textContent = totalEliminar;
        const anosOrdenados = Object.keys(conteoPorAno).sort((a, b) => b - a);
        document.getElementById("conteoPorAno").textContent = anosOrdenados.map(y => `${y}(${conteoPorAno[y]})`).join(', ');

        const ctx = document.getElementById("graficoAnios").getContext("2d");
        new Chart(ctx, {
          type: 'bar',
          data: { labels: anosOrdenados, datasets: [{ label: 'Registros por A√±o', data: anosOrdenados.map(y => conteoPorAno[y]), backgroundColor: 'rgba(54, 162, 235, 0.7)' }] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      });

    function parseFecha(fechaStr) {
      const partes = fechaStr.split("-");
      if (partes.length !== 3) return null;
      let [dd, mm, aa] = partes;
      let year = parseInt(aa);
      if (year < 100) year += (year < 25) ? 2000 : 1900;
      return new Date(year, parseInt(mm) - 1, parseInt(dd));
    }
    function filtrarTabla(rut) {
      const filas = document.querySelectorAll("#dataTable tbody tr");
      filas.forEach(fila => {
        fila.style.display = fila.cells[1].textContent.includes(rut) ? "" : "none";
      });
    }
  </script>

  <!-- ===== Reloj Control: procesamiento 100% en el navegador ===== -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const log = (m) => { const el = $('logProceso'); if (el) el.textContent += m + '\n'; };
      const setEstado = (m, color) => { const e = $('estadoProceso'); if (e) { e.textContent = m; e.style.color = color || 'inherit'; } };

      const FERIADOS_2025 = new Set([
        "2025-01-01","2025-04-18","2025-04-19","2025-05-01","2025-05-21","2025-06-29",
        "2025-07-16","2025-08-15","2025-09-18","2025-09-19","2025-10-12","2025-10-31",
        "2025-11-01","2025-12-08","2025-12-25"
      ]);
      const INCIDENCIAS_ANULAN = ['ausente','libre','falta entrada','falta salida'];

      function toDateISO_ddmmyyyy(s) {
        if (!s) return null;
        const m = String(s).trim().match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
        return m ? `${m[3]}-${m[2]}-${m[1]}` : null;
      }
      function parseHM(str) {
        if (!str) return null;
        const s = String(str).trim();
        if (s === '-' || !s.includes(':')) return null;
        const [h,m] = s.split(':').map(n => parseInt(n,10));
        return isNaN(h)||isNaN(m) ? null : h*60+m;
      }
      const HHMM = (min) => {
        min = Math.round(Number(min||0));
        if (min === 0) return "";
        const sign = min<0 ? '-' : '';
        const a = Math.abs(min);
        return `${sign}${String(Math.floor(a/60)).padStart(2,'0')}:${String(a%60).padStart(2,'0')}`;
      };

      function parseTurno(texto) {
        const times = Array.from(String(texto||'').matchAll(/\b(\d{1,2}):(\d{2})\b/g)).map(m => m[0]);
        let [lujuIni, lujuFin, viIni, viFin] = times;
        const toMin = (t)=>t?parseHM(t):null;
        return { luj_inicio: toMin(lujuIni), luj_fin: toMin(lujuFin), vi_inicio: toMin(viIni), vi_fin: toMin(viFin) };
      }
      const day = (iso) => (new Date(iso+'T00:00:00')).getDay();
      const esFinde = (iso) => { const d=day(iso); return d===0||d===6; };
      const esViernes = (iso) => day(iso)===5;
      const esFeriado = (iso) => FERIADOS_2025.has(iso);

      function jornadaMin(turno, iso) {
        if (!turno || esFinde(iso)) return {ini:null, fin:null};
        return esViernes(iso) ? {ini: turno.vi_inicio, fin: turno.vi_fin}
                              : {ini: turno.luj_inicio, fin: turno.luj_fin};
      }

      function calcularExtrasYAtraso({isoFecha, entMin, salMin, turno, descripcion}) {
        const desc = (descripcion||'').toLowerCase();
        const out = { atrasoMin:0, extra25:0, extra50:0 };

        if (INCIDENCIAS_ANULAN.some(k => desc.includes(k))) return out;
        if (entMin==null || salMin==null) return out;
        if (salMin < entMin) salMin += 24*60;

        const feriado = esFeriado(isoFecha);
        const finde   = esFinde(isoFecha);
        const {ini, fin} = jornadaMin(turno, isoFecha);

        if (ini!=null && fin!=null && !feriado) {
          if (entMin > ini) out.atrasoMin += entMin - ini;
          if (salMin < fin) out.atrasoMin += fin - salMin;
        }

        if (finde || feriado) {
          const total = salMin - entMin;
          if (total >= 30) out.extra50 = total;
          return out;
        }
        if (ini==null || fin==null) return out;

        const siete = 7*60, veintiuna = 21*60;

        if (entMin < ini) {
          if (entMin < siete) {
            out.extra50 += Math.max(0, Math.min(ini, siete) - entMin);
            out.extra25 += Math.max(0, ini - Math.max(entMin, siete));
          } else {
            out.extra25 += (ini - entMin);
          }
        }
        if (salMin > fin) {
          out.extra25 += Math.max(0, Math.min(salMin, veintiuna) - fin);
          if (salMin > veintiuna) out.extra50 += (salMin - veintiuna);
        }

        if ((out.extra25 + out.extra50) < 30) { out.extra25=0; out.extra50=0; }
        return out;
      }

      function leerFilasDesdeHTML(htmlText) {
        const wrap = document.createElement('div');
        wrap.innerHTML = htmlText;
        const rows = Array.from(wrap.querySelectorAll('tr')).map(tr =>
          Array.from(tr.querySelectorAll('th,td')).map(td => td.innerText.replace(/\s+/g,' ').trim())
        );
        return rows.filter(r => r.some(c => c && c !== '\u00A0'));
      }
      const valorMeta = (fila) => fila.slice(1).join(' ').replace(/^\s*:\s*/,'').trim();

      function procesar(rows) {
        const detalle = [];
        const resumen = new Map();
        let i=0, N=rows.length;

        while (i<N) {
          if (!(rows[i][0]||'').toLowerCase().startsWith('funcionario')) { i++; continue; }

          const meta = {Funcionario:'', Rut:'', Organigrama:'', Turno:'', Periodo:''};
          meta.Funcionario = valorMeta(rows[i++]);
          if (i<N && (rows[i][0]||'').toLowerCase().startsWith('rut'))         meta.Rut = valorMeta(rows[i++]);
          if (i<N && (rows[i][0]||'').toLowerCase().startsWith('organigrama')) meta.Organigrama = valorMeta(rows[i++]);
          if (i<N && (rows[i][0]||'').toLowerCase().startsWith('turno'))       meta.Turno = valorMeta(rows[i++]);
          if (i<N && (rows[i][0]||'').toLowerCase().startsWith('periodo'))     meta.Periodo = valorMeta(rows[i++]);

          const turno = parseTurno(meta.Turno);

          while (i<N) {
            const c0 = (rows[i][0]||'').toLowerCase();
            if (c0==='dia' || c0==='d√≠a') { i++; break; }
            if (['lu','ma','mi','ju','vi','sa','do'].includes(c0)) break;
            if (c0.startsWith('funcionario')) break;
            i++;
          }

          const DIAS = new Set(['lu','ma','mi','ju','vi','sa','do']);
          while (i<N) {
            const head = (rows[i][0]||'').toLowerCase();
            if (head.startsWith('funcionario')) break;
            if (!DIAS.has(head)) { i++; continue; }

            while (i<N && DIAS.has((rows[i][0]||'').toLowerCase())) {
              const fechaTxt = rows[i][1] || '';
              const iso = toDateISO_ddmmyyyy(fechaTxt);
              const entMin = parseHM(rows[i][2]);
              const salMin = parseHM(rows[i][3]);
              const descripcion = (rows[i][5] || rows[i][4] || '').trim();

              const { atrasoMin, extra25, extra50 } = calcularExtrasYAtraso({
                isoFecha: iso, entMin, salMin, turno, descripcion
              });

              detalle.push([
                meta.Funcionario, meta.Rut, meta.Organigrama, meta.Turno, meta.Periodo,
                fechaTxt, rows[i][2]||'', rows[i][3]||'', HHMM(atrasoMin), HHMM(extra50), HHMM(extra25), descripcion
              ]);

              const k = meta.Funcionario+'|'+meta.Rut;
              if (!resumen.has(k)) resumen.set(k,{Funcionario:meta.Funcionario,Rut:meta.Rut,Organigrama:meta.Organigrama,Turno:meta.Turno,Periodo:meta.Periodo,t50:0,t25:0,tAtr:0});
              const R = resumen.get(k);
              R.t50 += extra50; R.t25 += extra25; R.tAtr += atrasoMin;

              i++;
            }
            if (i<N && (rows[i][0]||'').toLowerCase()==='totales') i++;
          }
        }

        const resumenRows = Array.from(resumen.values()).map(R => [
          R.Funcionario, R.Rut, R.Organigrama, R.Turno, R.Periodo,
          HHMM(R.t50), HHMM(R.t25), HHMM(R.tAtr), HHMM(R.t50 + R.t25)
        ]);

        return { detalleRows: detalle, resumenRows };
      }

      function descargarXLSX({detalleRows, resumenRows}, nombre='resultado.xlsx') {
        const wb = XLSX.utils.book_new();
        const cab1 = ["Funcionario","Rut","Organigrama","Turno","Periodo","Fecha","Entrada","Salida","Atraso (HH:MM)","50% (HH:MM)","25% (HH:MM)","Descripci√≥n"];
        const cab2 = ["Funcionario","Rut","Organigrama","Turno","Periodo","Total 50%","Total 25%","Total Atraso","Total Horas Extra"];
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([cab1, ...detalleRows]), 'Detalle Diario');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([cab2, ...resumenRows]), 'Resumen');
        XLSX.writeFile(wb, nombre);
      }

      const form = document.getElementById("formRelojControl");
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          document.getElementById('logProceso').textContent = '';
          const file = document.getElementById('archivo').files[0];
          if (!file) { setEstado('Selecciona un archivo .xls', 'red'); return; }
          if (!file.name.toLowerCase().endsWith('.xls')) { setEstado('S√≥lo se aceptan archivos .xls', 'red'); return; }

          setEstado('‚è≥ Procesando archivo...', 'black');
          log('üì§ Leyendo archivo...');

          try {
            const html = await file.text();
            log('üß© Parseando HTML...');
            const rows = leerFilasDesdeHTML(html);
            log('üîé Filas encontradas: ' + rows.length);

            const {detalleRows, resumenRows} = procesar(rows);
            log(`‚úÖ Detalle: ${detalleRows.length} filas`);
            log(`‚úÖ Resumen: ${resumenRows.length} filas`);
            log('üì¶ Generando XLSX...');

            const base = file.name.replace(/\.[^.]+$/,'');
            descargarXLSX({detalleRows, resumenRows}, base + '_procesado.xlsx');

            setEstado('‚úÖ Listo. Archivo descargado.', 'green');
          } catch (err) {
            console.error(err);
            setEstado('‚ùå Ocurri√≥ un error al procesar el archivo.', 'red');
            log('‚ùå ' + (err && err.message ? err.message : String(err)));
          }
        });
      }
    })();
  </script>

<div id="confirmacionCitas" class="tab-content">
  <h2>CONFIRMAR CITAS - CESFAM Labranza</h2>

  <input type="file" id="fileInput" accept="application/pdf" multiple onchange="subirPDF()" />
  <button onclick="enviarMensajes()">Enviar mensajes</button>

  <table id="tablaCitas">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Profesional</th>
        <th>Estado</th>
        <th>Respuesta</th>
        <th>Contador</th>
      </tr>
    </thead>
    <tbody id="tablaBody"></tbody>
  </table>
</div>

<script>
async function subirPDF() {
  const input = document.getElementById("fileInput");
  const files = input.files;

  if (files.length === 0) {
    alert("Debes seleccionar al menos un archivo PDF.");
    return;
  }

  const formData = new FormData();
  for (const file of files) {
    formData.append("files", file);
  }

  try {
    const res = await fetch("https://confirmacion-de-horas-backend.onrender.com/procesar", {
      method: "POST",
      body: formData
    });

    if (!res.ok) throw new Error("Error procesando el archivo.");
    const data = await res.json();
    cargarTabla(data);
  } catch (error) {
    alert("Ocurri√≥ un error al procesar los archivos.");
    console.error(error);
  }
}


  async function enviarMensajes() {
    try {
      const res = await fetch("https://n8n.tudominio.com/webhook/enviar-mensajes", { method: "POST" });
      if (res.ok) {
        alert("Mensajes enviados correctamente.");
      } else {
        alert("Error al enviar mensajes.");
      }
    } catch (err) {
      console.error(err);
      alert("Fallo en la conexi√≥n con n8n.");
    }
  }

  function cargarTabla(citas) {
    const tbody = document.getElementById("tablaBody");
    tbody.innerHTML = "";

    citas.forEach(p => {
      const tr = document.createElement("tr");
      tr.className = p.estado.toLowerCase();

      tr.innerHTML = `
        <td>${p.nombre}</td>
        <td>${p.fecha}</td>
        <td>${p.hora}</td>
        <td>${p.profesional}</td>
        <td>${p.estado}</td>
        <td>${p.respuesta || "-"}</td>
        <td class="contador" id="contador-${p.id}">-</td>
      `;

      tbody.appendChild(tr);
      iniciarContador(p.id, p.limite);
    });
  }

  function iniciarContador(id, limite) {
    const el = document.getElementById("contador-" + id);
    const target = new Date(limite).getTime();

    const interval = setInterval(() => {
      const now = new Date().getTime();
      const diff = target - now;

      if (diff <= 0) {
        el.textContent = "‚õî Finalizado";
        clearInterval(interval);
      } else {
        const h = Math.floor(diff / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        el.textContent = `${h}h ${m}m`;
      }
    }, 60000);

    const now = new Date().getTime();
    const diff = target - now;
    if (diff > 0) {
      const h = Math.floor(diff / (1000 * 60 * 60));
      const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      el.textContent = `${h}h ${m}m`;
    } else {
      el.textContent = "‚õî Finalizado";
    }
  }
</script>

  <!-- ====== Archivos desde Google Drive (lista y descarga autom√°tica) ====== -->
  <script>
    // üîê Tu API Key de Google (Drive API habilitada y restringida por HTTP referrer a tu dominio)
    const apiKey = "AIzaSyDmAlHTd3SeDq8dF_gglAS5TJUc5tgGePk";
    // üìÅ ID de la carpeta
    const FOLDER_ID = "1Z3fZmlekSnD0jxYLzIEymUnbFRRBBRBq";

    async function listarArchivosCarpeta(folderId) {
      const base = "https://www.googleapis.com/drive/v3/files";
      const fields = encodeURIComponent("nextPageToken, files(id, name, mimeType, size, modifiedTime)");
      let pageToken = null;
      const todos = [];

      do {
        const q = encodeURIComponent(`'${folderId}' in parents and trashed=false`);
        const url =
          `${base}?q=${q}` +
          `&key=${apiKey}` +
          `&fields=${fields}` +
          `&pageSize=1000` +
          `&supportsAllDrives=true&includeItemsFromAllDrives=true` +
          (pageToken ? `&pageToken=${pageToken}` : '');

        const res = await fetch(url);
        if (!res.ok) {
          const t = await res.text();
          throw new Error(`Drive API error: ${res.status} ${t}`);
        }
        const data = await res.json();
        if (Array.isArray(data.files)) todos.push(...data.files);
        pageToken = data.nextPageToken || null;
      } while (pageToken);

      todos.sort((a,b) => (a.name||'').localeCompare(b.name||'')); // ordenar por nombre
      return todos;
    }

    function humanSize(bytes) {
      if (!bytes) return '';
      const n = Number(bytes);
      if (isNaN(n)) return '';
      const u = ['B','KB','MB','GB','TB'];
      let i = 0, val = n;
      while (val >= 1024 && i < u.length-1) { val/=1024; i++; }
      return `${val.toFixed(val<10?1:0)} ${u[i]}`;
    }

    async function openArchivosModal() {
      openModal('archivosModal');

      const estado = document.getElementById('estadoArchivos');
      const ul = document.getElementById('listaArchivos');
      ul.innerHTML = '';
      estado.textContent = 'Cargando archivos...';

      if (!apiKey) {
        estado.innerHTML = '‚ö†Ô∏è Falta API Key. Configura tu clave de Google Drive API y restringe por <b>HTTP referrer</b>.';
        return;
      }

      try {
        const files = await listarArchivosCarpeta(FOLDER_ID);
        if (!files.length) {
          estado.textContent = 'No hay archivos en la carpeta o no son p√∫blicos.';
          return;
        }
        estado.textContent = `Se encontraron ${files.length} archivo(s).`;

        files.forEach(f => {
          // Enlace de descarga directa
          const downloadUrl = `https://drive.google.com/uc?export=download&id=${encodeURIComponent(f.id)}`;

          const li = document.createElement('li');
          const left = document.createElement('div');
          const right = document.createElement('div');

          left.textContent = f.name || '(sin nombre)';
          right.className = 'file-meta';
          const size = humanSize(f.size);
          const date = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString() : '';
          right.textContent = [size, date].filter(Boolean).join(' ¬∑ ');

          li.appendChild(left);
          li.appendChild(right);

          li.title = 'Descargar';
          li.onclick = () => window.open(downloadUrl, '_blank');

          ul.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        estado.textContent = 'Error al listar archivos. Revisa la API Key, permisos de la carpeta y la consola del navegador.';
      }
    }
  </script>
</body>
</html>

